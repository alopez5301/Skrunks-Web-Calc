<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="description" content="Professional TFR curve calculator and TCR burnoff calculator for DTv5, Pocket Rocket, and ceramic dab cups. Achieve precise temperature control with Skrunk's calibration tools."/>
<meta name="keywords" content="TFR calculator, TCR calculator, DTv5 calculator, Pocket Rocket calibration, ceramic dab cup calculator, temperature curve generator, vaporizer calibration tools, mod calibration"/>
<meta name="author" content="Skrunkle"/>
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"/>

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://trythisvape.com/skrunktools"/>
<meta property="og:title" content="Skrunks Professional TFR & TCR Calculator Suite"/>
<meta property="og:description" content=""Professional TFR curve calculator and TCR burnoff calculator for DTv5, Pocket Rocket, and ceramic dab cups. Achieve precise temperature control with Skrunks calibration tools."/>
<meta property="og:site_name" content="TryThisVape"/>
<meta property="og:locale" content="en_US"/>

<!-- Twitter -->
<meta name="twitter:card" content="summary"/>
<meta name="twitter:url" content="https://trythisvape.com/skrunktools"/>
<meta name="twitter:title" content="Skrunks Professional TFR & TCR Calculator Suite"/>
<meta name="twitter:description" content="Professional TFR curve calculator and TCR burnoff calculator for precise ceramic dab cup temperature control. Free tools by Skrunkle."/>

<!-- Additional SEO Meta Tags -->
<meta name="canonical" content="https://trythisvape.com/skrunktools"/>
<link rel="canonical" href="https://trythisvape.com/skrunktools"/>
<meta name="theme-color" content="#007bff"/>
<meta name="msapplication-TileColor" content="#007bff"/>

<!-- Structured Data for SoftwareApplication -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Skrunks TFR & TCR Calculator Suite",
  "description": "Professional web-based calculator suite for TFR curve generation and TCR burnoff calculations for ceramic dab cups and vaporizers.",
  "url": "https://trythisvape.com/skrunktools",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Web Browser",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "author": {
    "@type": "Person",
    "name": "Skrunkle"
  },
  "publisher": {
    "@type": "Organization",
    "name": "TryThisVape",
    "url": "https://trythisvape.com"
  },
  "featureList": [
    "TFR curve calculation for 7-point and 8-point curves",
    "TSM fix mode for DNA mods",
    "Auto TFR clean mode",
    "TCR burnoff calculator",
    "CSV import/export functionality",
    "Temperature unit conversion (¬∞F/¬∞C)",
    "Dark mode support",    
    "Image repository browser"
  ]
}
</script>

<!-- Additional Tool Info -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "TFR Calculator",
  "description": "Calculate Temperature/Resistance curves for ceramic dab cups and vaporizers",
  "url": "https://trythisvape.com/skrunktools",
  "applicationCategory": "Calculator",
  "browserRequirements": "Requires JavaScript. Requires HTML5.",
  "author": {
    "@type": "Person",
    "name": "Skrunkle"
  },
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>
<style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:0 10px;background:#fff;color:#000;line-height:1.6}.nav-bar{display:flex;justify-content:center;background:#007bff;padding:5px 0;margin-bottom:15px;border-radius:0 0 8px 8px}.nav-button{background:transparent;color:#fff;border:none;padding:5px 15px;margin:0 3px;font-size:14px;cursor:pointer;border-radius:4px;transition:background-color .3s}.multiline-nav-button{line-height:1.2;padding-top:2px;padding-bottom:2px}.small-text{font-size:12px;display:block}.nav-button:hover{background:rgba(255,255,255,.2)}.nav-button.active{background:rgba(255,255,255,.3);font-weight:700}h2,h3{text-align:center;color:#007bff}fieldset{margin-bottom:10px;border:1px solid #ccc;padding:10px;border-radius:5px}button{margin:5px;padding:8px 12px;font-size:16px;background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}button:hover{background:#0056b3}input[type=number]{padding:8px;font-size:16px;border:1px solid #ccc;border-radius:5px;width:100%;box-sizing:border-box}.grid{width:100%;border-collapse:collapse;margin-bottom:10px;overflow-x:auto;display:block}.grid th,.grid td{border:1px solid #ddd;padding:8px;text-align:center}.grid th{background:#f2f2f2}#resultOutput{background:#f9f9f9;border:1px solid #ccc;padding:10px;white-space:pre-wrap;height:150px;overflow:auto;border-radius:5px}.tcr-container{background:#fff;padding:2em;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.1);max-width:500px;margin:0 auto;text-align:center}.saved-calculations{margin-top:20px;padding:10px;background:#e9ecef;border-radius:5px;text-align:left}.delete-btn{color:#777;cursor:pointer;margin-left:10px;font-weight:700}.delete-btn:hover{color:red}.module{display:none}.module.active{display:block}.submission-form{background:#e9ecef;padding:20px;border-radius:10px;margin-bottom:20px;max-width:900px;margin:0 auto}.submission-form input,.submission-form select,.submission-form textarea{width:100%;margin-bottom:10px;padding:8px;font-size:16px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}.submission-form .iframe-container{background:#fff;border-radius:5px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.submission-form iframe{width:100%;border:none;display:block;min-height:2000px}.image-repo-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:10px;background:#f2f2f2;border-radius:5px}.filter-container{display:flex;align-items:center}.filter-container label{margin-right:10px}#dimensionFilter{padding:8px;border-radius:5px;border:1px solid #ccc}.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;padding:10px}.image-card{border:1px solid #ddd;border-radius:5px;overflow:hidden;transition:transform .3s;display:flex;flex-direction:column;height:fit-content}.image-card:hover{transform:scale(1.03);box-shadow:0 4px 8px rgba(0,0,0,.1)}.image-card img{width:100%;height:auto;display:block;object-fit:contain}.image-info{padding:10px;font-size:14px;background:#f9f9f9}.download-btn{margin:0 10px 10px;padding:6px 10px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color .3s}.download-btn:hover{background:#0056b3}.scroll-to-top{position:fixed;bottom:20px;right:30px;z-index:99;width:40px;height:40px;background:#007bff;color:#fff;border:none;border-radius:50%;cursor:pointer;opacity:0;transition:opacity .3s,background-color .3s;display:flex;justify-content:center;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.3);pointer-events:none}.scroll-to-top.visible{opacity:.8;pointer-events:auto}.scroll-to-top:hover{opacity:1;background:#0056b3}.scroll-to-top::after{content:"^";font-size:30px;font-weight:700;line-height:.75;position:relative;top:4px}body.dark-mode{background:#121212;color:#e0e0e0}body.dark-mode .warning,body.dark-mode h2,body.dark-mode h3{color:#66b2ff}body.dark-mode .nav-bar{background:#0056b3}body.dark-mode .grid th{background:#1e1e1e}body.dark-mode .grid,body.dark-mode .grid th,body.dark-mode .grid td{border:1px solid #333}body.dark-mode #resultOutput{background:#1e1e1e;border:1px solid #444}body.dark-mode input[type=number],body.dark-mode input[type=text],body.dark-mode input[type=date],body.dark-mode select,body.dark-mode textarea{border:1px solid #444;background:#333;color:#e0e0e0}body.dark-mode input[type=number][readonly]{background:#2a2a2a}body.dark-mode button{background:#0056b3}body.dark-mode button:hover{background:#003d80}body.dark-mode .tcr-container{background:#2c2c2c;box-shadow:0 0 10px rgba(0,0,0,.5)}body.dark-mode .saved-calculations{background:#333}body.dark-mode .delete-btn{color:#bbb}body.dark-mode .submission-form{background:#2c2c2c}body.dark-mode .submission-form .iframe-container{background:#2c2c2c}body.dark-mode .submission-form iframe{background:#2c2c2c}body.dark-mode .image-repo-controls{background:#2c2c2c}body.dark-mode #dimensionFilter{background:#333;color:#e0e0e0;border-color:#444}body.dark-mode .image-card{border-color:#444}body.dark-mode .image-card:hover{box-shadow:0 4px 8px rgba(0,0,0,.5)}body.dark-mode .image-info{background:#1e1e1e}body.dark-mode .download-btn{background:#0056b3}body.dark-mode .download-btn:hover{background:#003d80}body.dark-mode .scroll-to-top{background:#0056b3}body.dark-mode .scroll-to-top:hover{background:#003d80}
/* Hide number input spin buttons only on readonly inputs */
input[type=number][readonly]::-webkit-outer-spin-button,
input[type=number][readonly]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Firefox: remove number input arrows for readonly */
input[type=number][readonly] {
    -moz-appearance: textfield;
}

/* Visual treatment for readonly number inputs to make them obvious */
input[type=number][readonly] {
    background: #000000;
    color: #ffffff;
    border-color: #222;
    cursor: default;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    border-radius: 8px;
}

/* Dark mode override for readonly inputs */
body.dark-mode input[type=number][readonly] {
    background: #000000;
    color: #ffffff;
    border-color: #111;
    border-radius: 8px;
}
</style>
</head>
<style>
/* Lock icon wrapper for readonly inputs */
.readonly-wrap{position:relative;display:block}
.readonly-wrap input[type=number]{padding-right:40px}
.readonly-wrap .lock-icon{position:absolute;right:10px;top:8px;width:18px;height:18px;pointer-events:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23ffffff" d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4zm-2 6a2 2 0 1 1 4 0v2H10V8z"/></svg>');background-size:18px 18px;background-repeat:no-repeat}
</style>
</head>
</head>
<body>
<div class="nav-bar">
    <button class="nav-button" id="tfrNavBtn" data-hash="tfr">Skrunks Easy TFR Curve</button>
    <button class="nav-button active" id="tcrNavBtn" data-hash="tcr">Skrunks Easy TCR Burnoff</button>
    <button class="nav-button multiline-nav-button" id="submitNavBtn" data-hash="submit">Submit TFR<br><span class="small-text">(Show Skrunk your curves)</span></button>
    <button class="nav-button" id="imageRepoNavBtn" data-hash="image">Skrunk Image Repo</button>
    <button class="nav-button" id="darkModeToggle">üåô</button>
</div>

<div id="tfrModule" class="module">
<h2>Skrunks Web TFR Calculator</h2>
<p class="small-text" style="text-align:center;margin-top:-6px;margin-bottom:10px;font-size:17px;font-weight:700;">Enter resistance values (Œ©) for each temperature row. Use the unit toggle to switch display between ¬∞F and ¬∞C.</p>
<div style="text-align:center;margin-bottom:10px;"><button id="tfrGuideButton" title="Open the full TFR guide in a new tab">TFR Guide</button></div>
<fieldset><legend>Curve Type</legend><label><input type="radio" name="curveType" value="7pt" checked> 7‚ÄëPoint Curve</label> <label><input type="radio" name="curveType" value="8pt"> 8‚ÄëPoint Curve</label> <label><input type="radio" name="curveType" value="tsm"> TSM Fix Mode</label> <label><input type="radio" name="curveType" value="auto"> Auto TFR Clean</label></fieldset>
<div id="extrapolateContainer" style="text-align:center;margin-bottom:10px;"><label><input type="checkbox" id="extrapolateCheck"> Extrapolate 800¬∞F value</label></div>
<div style="text-align:center;margin-bottom:10px;"><button id="tempUnitToggle">¬∞F / ¬∞C</button> <button id="importButton" title="Import a two-column CSV (temp,resist)">Import CSV</button> <button id="exportButton">Export CSV</button> <input type="file" id="csvFileInput" accept=".csv" style="display:none;"></div>
<div id="tfrStatus" class="small-text" style="text-align:center;color:#c0392b;min-height:18px;margin-bottom:8px"></div>
<div style="overflow-x:auto;"><table class="grid" id="gridContainer" aria-describedby="resultOutput"></table></div>
<div style="text-align:center;margin-bottom:10px;"><button id="calcButton">Calculate TFR</button></div>
<h3>Results:</h3>
<pre id="resultOutput"></pre>
</div>
<div id="tcrModule" class="module active">
<div class="tcr-container">
<h2>TCR Burnoff Calculator</h2>
<p>Enter your cold resistance (in ohms) below. This calculator assumes that at 600¬∞F your device's resistance will be 0.79 Œ© for XL cups and 0.90 Œ© for SM cups as required for burnoffs.</p>
<label for="coldRes">Cold Resistance (Œ©): </label><input type="number" id="coldRes" step="any" placeholder="e.g. 0.44" title="Enter measured cold resistance in ohms">
<fieldset style="margin-top:8px"><legend>Cup Size</legend>
    <label><input type="radio" name="tcrCup" value="XL" checked> XL</label>
    <label style="margin-left:10px"><input type="radio" name="tcrCup" value="SM"> SM</label>
</fieldset>
<button id="tcrCalcButton">Calculate</button>
<p class="warning"><strong>Warning:</strong> This tool performs standardized math for the temperature coefficient of resistance and then subtracts 3. While this should be accurate for all devices, it may not be accurate for yours. As such, Skrunk is not responsible for any damaged cups or mods that may occur due to the use of this calculator.</p>
<h3>Result</h3>
<p id="tcrResult"></p>
<h3>Saved Calculations</h3>
<div id="savedCalculations" class="saved-calculations"></div>
<div id="tcrStatus" class="small-text" style="text-align:center;color:#c0392b;min-height:18px;margin-top:8px"></div>
<div style="text-align:center;margin-top:8px"><button id="clearSavedBtn" style="background:#6c757d">Clear Saved</button></div>
</div>
</div>
<div id="submitModule" class="module">
<div class="submission-form">
<h2>Submit Your TFR Curve</h2>
<div class="iframe-container">
<iframe src="https://docs.google.com/forms/d/e/1FAIpQLScSHdM6HtYnTjNJg4ZMBefj7amE1tOi5I1WmrxH22attDVZtw/viewform?embedded=true" width="100%" height="2000" frameborder="0" marginheight="0" marginwidth="0">Loading‚Ä¶</iframe>
</div>
</div>
</div>
<div id="imageRepoModule" class="module">
<h2>Skrunk Image Repository</h2>
<div class="image-repo-controls">
<div class="filter-container">
    <label for="dimensionFilter">Filter by dimensions:</label>
    <select id="dimensionFilter" onchange="displayImages(cachedImages)">
        <option value="all">All Images</option>
    </select>
</div>
</div>
<div id="imageContainer" class="image-grid"><p id="loadingImages">Loading images...</p></div>
<button id="scrollToTopBtn" class="scroll-to-top" title="Go to top"></button>
</div>
<script>
const temperatureSets={'7pt':[70,200,300,400,500,570,800],'8pt':[-40,70,200,300,400,500,570,800],'tsm':[-40,70,200,220,300,500,570,800],'auto':[70,200,300,400,500,600,800]};
let currentType='7pt',currentTemperatures=temperatureSets[currentType],tempInputs={},resInputs={},calculatedCoefficients=[],isCelsius=!1,cachedImages=[];
function fahrenheitToCelsius(e){return Math.round((e-32)*5/9)}
function celsiusToFahrenheit(e){return Math.round(e*9/5+32)}
function toggleTemperatureUnit(){const e={};currentTemperatures.forEach(t=>{resInputs[t]&&(e[t]=resInputs[t].value)}),isCelsius=!isCelsius,updateGrid(e)}
function updateGrid(e=null){
    tempInputs = {};
    resInputs = {};
    const container = document.getElementById("gridContainer");
    container.innerHTML = "";

    const headerRow = document.createElement("tr");
    const thTemp = document.createElement("th");
    thTemp.innerText = `Temperature (${isCelsius ? "¬∞C" : "¬∞F"})`;
    const thRes = document.createElement("th");
    thRes.innerText = "Resistance Value";
    headerRow.appendChild(thTemp);
    headerRow.appendChild(thRes);
    container.appendChild(headerRow);

    currentTemperatures.forEach(temp => {
        const row = document.createElement("tr");
        const tempCell = document.createElement("td");
        const displayTemp = isCelsius ? fahrenheitToCelsius(temp) : temp;

        if (currentType === "tsm") {
            if (temp === -40 || temp === 70 || temp === 200 || temp === 220) {
                tempCell.innerText = displayTemp;
                tempCell.dataset.fahrenheit = temp;
            } else {
                const input = document.createElement("input");
                input.type = "number";
                input.value = displayTemp;
                input.step = "1";
                input.dataset.fahrenheit = temp;
                tempCell.appendChild(input);
                tempInputs[temp] = input;
            }
        } else if (currentType === "auto") {
            tempCell.innerText = displayTemp;
            tempCell.dataset.fahrenheit = temp;
        } else {
            const input = document.createElement("input");
            input.type = "number";
            input.value = displayTemp;
            input.step = "1";
            input.dataset.fahrenheit = temp;
            tempCell.appendChild(input);
            tempInputs[temp] = input;
        }

        row.appendChild(tempCell);

        const resCell = document.createElement("td");
        const resInput = document.createElement("input");
        resInput.type = "number";
        resInput.step = "0.001";

        if (currentType === "tsm") {
            if (temp === -40 || temp === 200) {
                resInput.readOnly = true;
                // visually indicate readonly via wrapper
                applyReadonlyWrap(resInput);
            }
            if (temp === 70) resInput.addEventListener("input", updateTSMValues);
        } else if (currentType === "auto") {
            if (temp === 70) resInput.addEventListener("input", autoFillValues);
            else {
                resInput.readOnly = true;
                applyReadonlyWrap(resInput);
            }
        }

        if (e && typeof e[temp] !== 'undefined') resInput.value = e[temp];
        resCell.appendChild(resInput);
        row.appendChild(resCell);

    resInputs[temp] = resInput;
    // safety: if this input ended up readonly, ensure wrapper/icon applied
    if (resInput.readOnly) applyReadonlyWrap(resInput);
        container.appendChild(row);
    });

    setTimeout(setupExtrapolationListeners, 0);
}
// Helper to wrap a readonly input with a visual lock icon
function applyReadonlyWrap(i){if(!i) return;const p=i.parentElement; if(p&&p.classList&&p.classList.contains('readonly-wrap')) return; const w=document.createElement('div');w.className='readonly-wrap'; i.replaceWith(w); w.appendChild(i); const ic=document.createElement('span');ic.className='lock-icon'; w.appendChild(ic);}function removeReadonlyWrap(i){if(!i) return;const p=i.parentElement; if(!p||!p.classList||!p.classList.contains('readonly-wrap')) return; const g=p.parentElement; if(!g) return; g.replaceChild(i,p);} 
function displaySavedCalculations(){
    var e = JSON.parse(localStorage.getItem("calculations")) || [];
    var t = document.getElementById("savedCalculations");
    if (!t) return;
    if (e.length === 0) {
        t.innerHTML = '<div class="small-text">No saved calculations yet</div>';
        return;
    }
    t.innerHTML = e.map((entry, idx) => `Cold Resistance: ${entry.coldRes} Œ© - Required TCR: ${entry.tcrFull} (${entry.cup||'XL'}) <span class="delete-btn" onclick="deleteCalculation(${idx})">&times;</span>`).join("<br>");
}
function showModule(e){document.querySelectorAll(".module").forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active")}
function updateNavButtons(e){document.querySelectorAll(".nav-button").forEach(t=>{t.id===e?t.classList.add("active"):t.id!=="darkModeToggle"&&t.classList.remove("active")})}
function applyDarkMode(){const e=localStorage.getItem("darkMode")!=="false";if(e){document.body.classList.add("dark-mode");const t=document.getElementById("darkModeToggle");t&&(t.textContent="üåô")}else{document.body.classList.remove("dark-mode");const t=document.getElementById("darkModeToggle");t&&(t.textContent="‚òÄÔ∏è")}}
function autoFillValues(){if("auto"!==currentType)return;const e=parseFloat(resInputs[70].value);if(isNaN(e)||e<=0)return;const t=e+.001,n=.79,r=1.2*n;currentTemperatures.forEach(a=>{if(70===a)return;let s;if(a===200)s=t;else if(a===600)s=n;else if(a===800)s=r;else{const e=(a-200)/(600-200),r=Math.pow(e,2);s=t+(n-t)*r}resInputs[a].value=s.toFixed(3)})}
function updateTSMValues(){if("tsm"!==currentType)return;const e=parseFloat(resInputs[70].value);if(isNaN(e)||e<=0)return;const t=.92*e;resInputs[-40].value=t.toFixed(3),resInputs[200].value=(e+.001).toFixed(3)}
function calculateTFR(){
    var statusEl = document.getElementById('tfrStatus');
    if(statusEl) { statusEl.textContent = ''; }
    if ("auto"===currentType ? autoFillValues() : "tsm"===currentType && updateTSMValues(), temps = [], currentTemperatures.forEach(e => { if (tempInputs[e]) { let t = parseFloat(tempInputs[e].value); isCelsius && !isNaN(t) && (t = celsiusToFahrenheit(t)); temps.push(isNaN(t) ? e : t) } else temps.push(e) }), values = [], currentTemperatures.length > 0) {
        for (let i = 0; i < currentTemperatures.length; i++) {
            const val = parseFloat(resInputs[currentTemperatures[i]].value);
            if (isNaN(val)) { if (statusEl) { statusEl.textContent = 'Please enter all resistance values.'; statusEl.style.color = '#c0392b'; } return; }
            values.push(val);
        }
        const base = values["tsm"===currentType ? 1 : 0];
        calculatedCoefficients = [];
        let out = "Temperature (¬∞F), Electrical Resistivity\n";
        values.forEach((n, r) => { let a = n / base; a = parseFloat(a.toFixed(3)); let s = temps[r]; calculatedCoefficients.push({ temp: s, coef: a }); out += `${s}, ${a.toFixed(3)}\n`; });
        document.getElementById("resultOutput").innerText = out;
        if (statusEl) { statusEl.textContent = 'TFR calculated ‚Äî see results below.'; statusEl.style.color = '#1abc9c'; }
    }
}
    function importCSV(raw){
        var statusEl = document.getElementById('tfrStatus');
        if(statusEl) statusEl.textContent = '';
        const rows = raw.trim().split(/\r?\n/);
        if (rows.length < 2) { if(statusEl){ statusEl.textContent = 'CSV file does not contain valid data.'; statusEl.style.color = '#c0392b'; } return }
        const temps = [], vals = [];
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i].split(/,|;/);
            if (cols.length >= 2) {
                const t = parseFloat(cols[0].replace(/"/g,"").trim());
                const v = parseFloat(cols[1].replace(/"/g,"").trim());
                if (!isNaN(t) && !isNaN(v)) { temps.push(t); vals.push(v); }
            }
        }
        if (temps.length === 0) { if(statusEl){ statusEl.textContent = 'No valid data found in CSV file.'; statusEl.style.color = '#c0392b'; } return }
        let detected = '7pt';
        if (temps.length === 8) detected = (temps.includes(220) || temps.some(x => Math.abs(x - 220) < 1)) ? 'tsm' : '8pt';
        else if (temps.length === 7) detected = (temps.includes(600) || temps.some(x => Math.abs(x - 600) < 1)) ? 'auto' : '7pt';
        let base = parseFloat(window.prompt('Enter base resistance value:', '1.0'));
        if (isNaN(base)) { if(statusEl){ statusEl.textContent = 'Invalid base resistance. Import aborted.'; statusEl.style.color = '#c0392b'; } return }
        currentType = detected;
        document.querySelectorAll("input[name='curveType']").forEach(rb => { rb.checked = (rb.value === currentType); });
        currentTemperatures = [...temps];
        updateGrid();
        temps.forEach((t, idx) => { if (resInputs[t]) resInputs[t].value = (vals[idx] * base).toFixed(3); if (tempInputs[t]) tempInputs[t].value = t; });
        if (currentType === 'tsm' && resInputs[-40] && resInputs[70] && !resInputs[-40].value) { let v = parseFloat(resInputs[70].value); if (!isNaN(v)) resInputs[-40].value = (0.92 * v).toFixed(3); }
        if(statusEl){ statusEl.textContent = `CSV data imported (base ${base}).`; statusEl.style.color = '#1abc9c'; }
    }

function findClosestTemperature(e,t){let n=t[0],r=Math.abs(e-n);for(let a=1;a<t.length;a++){const s=Math.abs(e-t[a]);s<r&&(r=s,n=t[a])}return n}
function findBestCurveTypeMatch(e){const t=Object.keys(temperatureSets);let n={curveType:"7pt",mismatches:[],score:Number.MAX_SAFE_INTEGER};return t.forEach(t=>{const r=temperatureSets[t];if(r.length===e.length){const t=[...e].sort((e,t)=>e-t),a=[...r].sort((e,t)=>e-t);let s=[],i=0;for(let e=0;e<t.length;e++){const n=Math.abs(t[e]-a[e]);i+=n,n>3&&s.push({csvTemp:t[e],expectedTemp:a[e]})}(s.length<n.mismatches.length||s.length===n.mismatches.length&&i<n.score)&&(n={curveType:t,mismatches:s,score:i})}}),n}
function exportCSV(){
    var statusEl = document.getElementById('tfrStatus');
    if (!calculatedCoefficients.length) { if(statusEl){ statusEl.textContent = 'Please calculate TFR values first!'; statusEl.style.color = '#c0392b'; } return }
    let csv = "Temperature (¬∞F),Electrical Resistivity\n";
    calculatedCoefficients.forEach(it => { csv += `${it.temp},${it.coef.toFixed(3)}\n`; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', 'tfrcalc.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    if(statusEl){ statusEl.textContent = 'CSV exported.'; statusEl.style.color = '#1abc9c'; }
}
function calculateTCR(){
    var statusEl = document.getElementById('tcrStatus');
    if (statusEl) statusEl.textContent = '';
    var val = parseFloat(document.getElementById('coldRes').value);
    if (isNaN(val) || val <= 0) { if(statusEl){ statusEl.textContent = 'Please enter a valid positive number for cold resistance.'; statusEl.style.color = '#c0392b'; } document.getElementById('tcrResult').innerText = ''; return }
    var cup = (document.querySelector('input[name="tcrCup"]:checked') || { value: 'XL' }).value;
    var baseline = cup === 'SM' ? 0.90 : 0.79;
    var t = (baseline / val - 1) / 600;
    var n = Math.round(2e5 * t) - 3;
    document.getElementById('tcrResult').innerText = 'Required TCR (full number): ' + n + ' (' + cup + ')';
    saveCalculation(val, n, cup);
    displaySavedCalculations();
    if(statusEl){ statusEl.textContent = 'Calculation saved.'; statusEl.style.color = '#1abc9c'; }
}
function saveCalculation(e,t,c){var n=JSON.parse(localStorage.getItem("calculations"))||[];n.push({coldRes:e,tcrFull:t,cup:c}),localStorage.setItem("calculations",JSON.stringify(n))}
function deleteCalculation(e){var t=JSON.parse(localStorage.getItem("calculations"))||[];t.splice(e,1),localStorage.setItem("calculations",JSON.stringify(t)),displaySavedCalculations()}
function extrapolate800Value(){
    if(!document.getElementById("extrapolateCheck").checked) return;
    if(!currentTemperatures.includes(800)) return;
    const e = currentTemperatures.indexOf(800);
    if(e === -1 || e < 2) return;
    const t = currentTemperatures[e-2], n = currentTemperatures[e-1];
    const r = resInputs[t], a = resInputs[n], s = resInputs[800];
    if(!r || !a || !s) return;
    const i = parseFloat(r.value), o = parseFloat(a.value);
    if(isNaN(i) || isNaN(o)) return;
    const c = (o - i) / (n - t), l = o - c * n, d = 800 * c + l;
    s.value = d.toFixed(3);
    s.readOnly = true;
    applyReadonlyWrap(s);
}
function setupExtrapolationListeners(){if(!currentTemperatures.includes(800))return;const e=currentTemperatures.indexOf(800);if(e<2)return;const t=currentTemperatures[e-2],n=currentTemperatures[e-1];resInputs[t]&&resInputs[t].addEventListener("input",extrapolate800Value),resInputs[n]&&resInputs[n].addEventListener("input",extrapolate800Value),document.getElementById("extrapolateCheck").checked&&extrapolate800Value()}
function setupScrollToTopButton(){const e=document.getElementById("scrollToTopBtn");window.addEventListener("scroll",function(){document.getElementById("imageRepoModule").classList.contains("active")&&e.classList[window.pageYOffset>200?"add":"remove"]("visible")}),e.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"}))}
async function fetchImagesFromGitHub(){
    const loadingElem = document.getElementById("loadingImages");
    loadingElem.textContent = "Loading images...";
    try {
        const response = await fetch("https://api.github.com/repos/alopez5301/AFREPO/contents/images");
        if(!response.ok) throw new Error(`GitHub API error: ${response.status}`);
        
        const data = await response.json();
        const imageFiles = data.filter(file => /\.(jpg|jpeg|png|bmp)$/i.test(file.name));
        
        // Reset cached images and create a loading map to prevent duplicates
        cachedImages = [];
        const loadingMap = new Map();
        const totalImages = imageFiles.length;
        
        // Process all images
        const promises = imageFiles.map(async (file) => {
            if (!loadingMap.has(file.name)) {
                loadingMap.set(file.name, getImageDetails(file));
            }
            return loadingMap.get(file.name);
        });
        
        // Process images one by one to show accurate progress
        for (let i = 0; i < promises.length; i++) {
            const details = await promises[i];
            if (!cachedImages.some(img => img.name === details.name)) {
                cachedImages.push(details);
                loadingElem.textContent = `Loading images... (${cachedImages.length}/${totalImages})`;
            }
        }
        
        updateDimensionFilter(cachedImages);
        displayImages(cachedImages);
    } catch(error) {
        loadingElem.textContent = `Error loading images: ${error.message}`;
        console.error("Error fetching images:", error);
    }
}
async function getImageDetails(file) {
    const url = file.download_url;
    return new Promise((resolve) => {
        const img = new Image();
        let resolved = false;
        
        img.onload = () => {
            if (!resolved) {
                resolved = true;
                resolve({
                    name: file.name,
                    url: url,
                    width: img.width,
                    height: img.height
                });
            }
        };
        
        img.onerror = () => {
            if (!resolved) {
                resolved = true;
                resolve({
                    name: file.name,
                    url: url,
                    width: 0,
                    height: 0
                });
            }
        };
        
        img.src = url;
    });
}
function updateDimensionFilter(images) {
    const dimensions = new Set();
    images.forEach(img => {
        if (img.width > 0 && img.height > 0) {
            dimensions.add(`${img.width}x${img.height}`);
        }
    });

    const select = document.getElementById("dimensionFilter");
    const currentValue = select.value;

    // Clear existing options except "All Images"
    while (select.options.length > 1) {
        select.remove(1);
    }

    // Sort dimensions first by width, then by height
    Array.from(dimensions)
        .map(dim => {
            const [w, h] = dim.split('x').map(Number);
            return { dim, width: w, height: h };
        })
        .sort((a, b) => {
            // First sort by width
            if (a.width !== b.width) {
                return a.width - b.width;
            }
            // If widths are equal, sort by height
            return a.height - b.height;
        })
        .forEach(({ dim }) => {
            const option = document.createElement("option");
            option.value = dim;
            option.textContent = dim;
            select.appendChild(option);
        });

    // Try to maintain the current selection if it still exists
    const exists = Array.from(select.options).some(opt => opt.value === currentValue);
    select.value = exists ? currentValue : "all";
    
    // Trigger a change event to update the display
    const changeEvent = new Event('change', { bubbles: true });
    select.dispatchEvent(changeEvent);
}
function displayImages(e) {
    if (!e || !Array.isArray(e)) return;

    const container = document.getElementById("imageContainer");
    const dimensionFilter = document.getElementById("dimensionFilter").value;
    const loadingMsg = document.getElementById("loadingImages");
    
    // Clear the container while keeping the loading message
    Array.from(container.children).forEach(child => {
        if (child !== loadingMsg) child.remove();
    });
    
    // Filter images
    let filteredImages = e.filter(img => img && img.width > 0 && img.height > 0);
    if (dimensionFilter !== "all") {
        const [width, height] = dimensionFilter.split("x").map(Number);
        filteredImages = filteredImages.filter(img => img.width === width && img.height === height);
    }
    
    // Handle no results
    if (filteredImages.length === 0) {
        loadingMsg.textContent = dimensionFilter === "all" 
            ? "No valid images found"
            : `No images found with dimensions ${dimensionFilter}`;
        loadingMsg.style.display = "block";
        return;
    }
    
    // Sort by width first, then height, then name for consistent ordering
    filteredImages.sort((a, b) => {
        // First sort by width
        if (a.width !== b.width) {
            return a.width - b.width;
        }
        // If widths are equal, sort by height
        if (a.height !== b.height) {
            return a.height - b.height;
        }
        // If dimensions are equal, sort by name
        return a.name.localeCompare(b.name);
    });
    
    loadingMsg.style.display = "none";
    
    // Create and append all images using DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    const template = document.createElement("template");
    template.innerHTML = `
        <div class="image-card">
            <img style="width:100%;height:auto;cursor:pointer" loading="lazy">
            <div class="image-info"></div>
            <button class="download-btn">Download</button>
        </div>`;
    
    filteredImages.forEach(image => {
        const card = template.content.cloneNode(true).firstElementChild;
        const img = card.querySelector("img");
        img.src = image.url;
        img.alt = image.name;
        img.addEventListener("click", () => window.open(image.url, "_blank"));
        card.querySelector(".image-info").textContent = `${image.name} (${image.width}x${image.height})`;
        
        const downloadBtn = card.querySelector(".download-btn");
        downloadBtn.addEventListener("click", e => {
            e.stopPropagation();
            const a = document.createElement("a");
            a.href = image.url;
            a.download = image.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
        
        fragment.appendChild(card);
    });
    
    container.appendChild(fragment);
}
document.querySelectorAll("input[name='curveType']").forEach(e=>{e.addEventListener("change",function(){this.checked&&(currentType=this.value,currentTemperatures=temperatureSets[currentType],updateGrid(),document.getElementById("extrapolateContainer").style.display="auto"===currentType?"none":"block",setTimeout(setupExtrapolationListeners,100))})});
document.getElementById("extrapolateCheck").addEventListener("change",function(){
    const e = resInputs[800];
    if(this.checked){
        extrapolate800Value();
        if (e) { e.readOnly = true; applyReadonlyWrap(e); }
    } else if(e){
        e.readOnly = false;
        e.value = "";
        removeReadonlyWrap(e);
    }
});
document.getElementById("calcButton").addEventListener("click",calculateTFR);
document.getElementById("exportButton").addEventListener("click",exportCSV);
document.getElementById("importButton").addEventListener("click",()=>document.getElementById("csvFileInput").click());
document.getElementById("csvFileInput").addEventListener("change",function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>importCSV(e.target.result),e.readAsText(t),this.value=""}});
document.getElementById("tcrCalcButton").addEventListener("click",calculateTCR);
document.getElementById("tempUnitToggle").addEventListener("click",toggleTemperatureUnit);
document.getElementById("tfrNavBtn").addEventListener("click",function(){showModule("tfrModule"),updateNavButtons("tfrNavBtn")});
document.getElementById("tcrNavBtn").addEventListener("click",function(){showModule("tcrModule"),updateNavButtons("tcrNavBtn")});
document.getElementById("submitNavBtn").addEventListener("click",function(){showModule("submitModule"),updateNavButtons("submitNavBtn")});
document.getElementById("imageRepoNavBtn").addEventListener("click",function(){showModule("imageRepoModule"),updateNavButtons("imageRepoNavBtn"),0===cachedImages.length&&fetchImagesFromGitHub(),setupScrollToTopButton()});
document.getElementById("darkModeToggle").addEventListener("click",function(){document.body.classList.toggle("dark-mode");const e=document.body.classList.contains("dark-mode");localStorage.setItem("darkMode",e?"true":"false"),this.textContent=e?"üåô":"‚òÄÔ∏è"});
document.getElementById('tfrGuideButton').addEventListener('click', function() {
    window.open('https://trythisvape.com/tfrguide', '_blank');
});

document.addEventListener("DOMContentLoaded", function() {
    applyDarkMode();
    // Ensure 7‚ÄëPoint curve is selected on reload so TFR defaults to the 7pt grid
    try {
        const rb7 = document.querySelector("input[name='curveType'][value='7pt']");
        if (rb7) { rb7.checked = true; currentType = '7pt'; currentTemperatures = temperatureSets[currentType]; }
    } catch (e) { /* ignore if DOM not ready */ }
    updateGrid();
    displaySavedCalculations();
    setupExtrapolationListeners();

    // Handle URL hash navigation
    function handleHash() {
        const hash = window.location.hash.slice(1) || 'tcr';
        switch(hash) {
            case 'tfr':
                showModule('tfrModule');
                updateNavButtons('tfrNavBtn');
                break;
            case 'tcr':
                showModule('tcrModule');
                updateNavButtons('tcrNavBtn');
                break;
            case 'submit':
                showModule('submitModule');
                updateNavButtons('submitNavBtn');
                break;
            case 'image':
                showModule('imageRepoModule');
                updateNavButtons('imageRepoNavBtn');
                if (cachedImages.length === 0) fetchImagesFromGitHub();
                setupScrollToTopButton();
                break;
        }
    }

    // Listen for hash changes
    window.addEventListener('hashchange', handleHash);
    
    // Initial hash handling
    handleHash();

    // Add hash handling to nav buttons
    document.getElementById('tfrNavBtn').addEventListener('click', () => {
        window.location.hash = 'tfr';
    });
    document.getElementById('tcrNavBtn').addEventListener('click', () => {
        window.location.hash = 'tcr';
    });
    document.getElementById('submitNavBtn').addEventListener('click', () => {
        window.location.hash = 'submit';
    });
    document.getElementById('imageRepoNavBtn').addEventListener('click', () => {
        window.location.hash = 'image';
    });
    // Clear saved calculations button
    var clearBtn = document.getElementById('clearSavedBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function(){
            localStorage.removeItem('calculations');
            displaySavedCalculations();
            var s = document.getElementById('tcrStatus');
            if (s) { s.textContent = 'All saved calculations cleared.'; s.style.color = '#1abc9c'; }
        });
    }
});
</script>
</body>
</html>
