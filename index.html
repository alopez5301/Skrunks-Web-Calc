<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skrunks Calculator Web Suite</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:0 10px;background:#fff;color:#000;line-height:1.6}
    .nav-bar{display:flex;justify-content:center;background:#007bff;padding:5px 0;margin-bottom:15px;border-radius:0 0 8px 8px}
    .nav-button{background:transparent;color:#fff;border:none;padding:5px 15px;margin:0 3px;font-size:14px;cursor:pointer;border-radius:4px;transition:background-color .3s}
    .nav-button:hover{background:rgba(255,255,255,.2)}
    .nav-button.active{background:rgba(255,255,255,.3);font-weight:700}
    h2,h3{text-align:center;color:#007bff}
    fieldset{margin-bottom:10px;border:1px solid #ccc;padding:10px;border-radius:5px}
    button{margin:5px;padding:8px 12px;font-size:16px;background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}
    button:hover{background:#0056b3}
    input[type=number]{padding:8px;font-size:16px;border:1px solid #ccc;border-radius:5px;width:100%;box-sizing:border-box}
    .grid{width:100%;border-collapse:collapse;margin-bottom:10px;overflow-x:auto;display:block}
    .grid th,.grid td{border:1px solid #ddd;padding:8px;text-align:center}
    .grid th{background:#f2f2f2}
    #resultOutput{background:#f9f9f9;border:1px solid #ccc;padding:10px;white-space:pre-wrap;height:150px;overflow:auto;border-radius:5px}
    .tcr-container{background:#fff;padding:2em;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.1);max-width:500px;margin:0 auto;text-align:center}
    .saved-calculations{margin-top:20px;padding:10px;background:#e9ecef;border-radius:5px;text-align:left}
    .delete-btn{color:#777;cursor:pointer;margin-left:10px;font-weight:700}
    .delete-btn:hover{color:red}
    .module{display:none}
    .module.active{display:block}
    .submission-form{background:#e9ecef;padding:20px;border-radius:10px;margin-bottom:20px;max-width:500px;margin:0 auto}
    .submission-form input,.submission-form select,.submission-form textarea{width:100%;margin-bottom:10px;padding:8px;font-size:16px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}
    .image-repo-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:10px;background:#f2f2f2;border-radius:5px}
    .filter-container{display:flex;align-items:center}
    .filter-container label{margin-right:10px}
    #dimensionFilter{padding:8px;border-radius:5px;border:1px solid #ccc}
    .image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;padding:10px}
    .image-card{border:1px solid #ddd;border-radius:5px;overflow:hidden;transition:transform .3s;display:flex;flex-direction:column;height:fit-content}
    .image-card:hover{transform:scale(1.03);box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .image-card img{width:100%;height:auto;display:block;object-fit:contain}
    .image-info{padding:10px;font-size:14px;background:#f9f9f9}
    .download-btn{margin:0 10px 10px;padding:6px 10px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color .3s}
    .download-btn:hover{background:#0056b3}
    .scroll-to-top{position:fixed;bottom:20px;right:30px;z-index:99;width:40px;height:40px;background:#007bff;color:#fff;border:none;border-radius:50%;cursor:pointer;opacity:0;transition:opacity .3s,background-color .3s;display:flex;justify-content:center;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.3);pointer-events:none}
    .scroll-to-top.visible{opacity:.8;pointer-events:auto}
    .scroll-to-top:hover{opacity:1;background:#0056b3}
    .scroll-to-top::after{content:"^";font-size:30px;font-weight:700;line-height:.75;position:relative;top:4px}
    
    body.dark-mode{background:#121212;color:#e0e0e0}
    body.dark-mode .warning,body.dark-mode h2,body.dark-mode h3{color:#66b2ff}
    body.dark-mode .nav-bar{background:#0056b3}
    body.dark-mode .grid th{background:#1e1e1e}
    body.dark-mode .grid,body.dark-mode .grid th,body.dark-mode .grid td{border:1px solid #333}
    body.dark-mode #resultOutput{background:#1e1e1e;border:1px solid #444}
    body.dark-mode input[type=number],body.dark-mode input[type=text],body.dark-mode input[type=date],body.dark-mode select,body.dark-mode textarea{border:1px solid #444;background:#333;color:#e0e0e0}
    body.dark-mode input[type=number][readonly]{background:#2a2a2a}
    body.dark-mode button{background:#0056b3}
    body.dark-mode button:hover{background:#003d80}
    body.dark-mode .tcr-container{background:#2c2c2c;box-shadow:0 0 10px rgba(0,0,0,.5)}
    body.dark-mode .saved-calculations{background:#333}
    body.dark-mode .delete-btn{color:#bbb}
    body.dark-mode .submission-form{background:#2c2c2c}
    body.dark-mode .image-repo-controls{background:#2c2c2c}
    body.dark-mode #dimensionFilter{background:#333;color:#e0e0e0;border-color:#444}
    body.dark-mode .image-card{border-color:#444}
    body.dark-mode .image-card:hover{box-shadow:0 4px 8px rgba(0,0,0,.5)}
    body.dark-mode .image-info{background:#1e1e1e}
    body.dark-mode .download-btn{background:#0056b3}
    body.dark-mode .download-btn:hover{background:#003d80}
    body.dark-mode .scroll-to-top{background:#0056b3}
    body.dark-mode .scroll-to-top:hover{background:#003d80}
    
    @media (max-width:600px){
      body{font-size:14px}
      button{font-size:14px;padding:6px 10px}
      input[type=number]{font-size:14px}
      .grid th,.grid td{padding:6px}
      fieldset{padding:8px}
      .nav-button{padding:4px 10px;font-size:13px}
    }
  </style>
</head>
<body>
  <div class="nav-bar">
    <button class="nav-button" id="tfrNavBtn">Skrunks Easy TFR Curve</button>
    <button class="nav-button active" id="tcrNavBtn">Skrunks Easy TCR Burnoff</button>
    <button class="nav-button" id="submitNavBtn">Submit TFR               (Show Skrunk your curves)</button>
    <button class="nav-button" id="imageRepoNavBtn">Skrunk Image Repo</button>
    <button class="nav-button" id="darkModeToggle">üåô</button>
  </div>

  <div id="tfrModule" class="module">
    <h2>Skrunks Web TFR Calc</h2>
    <fieldset>
      <legend>Curve Type</legend>
      <label><input type="radio" name="curveType" value="7pt" checked> 7‚ÄëPoint Curve</label>
      <label><input type="radio" name="curveType" value="8pt"> 8‚ÄëPoint Curve</label>
      <label><input type="radio" name="curveType" value="tsm"> TSM Fix Mode</label>
      <label><input type="radio" name="curveType" value="auto"> Auto TFR Clean</label>
    </fieldset>
    <div id="extrapolateContainer" style="text-align: center; margin-bottom: 10px;">
      <label><input type="checkbox" id="extrapolateCheck"> Extrapolate 800¬∞F value</label>
    </div>
    <div style="text-align: center; margin-bottom: 10px;">
      <button id="tempUnitToggle">¬∞F / ¬∞C</button>
      <button id="importButton">Import CSV</button>
      <button id="exportButton">Export CSV</button>
      <input type="file" id="csvFileInput" accept=".csv" style="display:none;">
    </div>
    <div style="overflow-x:auto;">
      <table class="grid" id="gridContainer"></table>
    </div>
    <div style="text-align: center; margin-bottom: 10px;">
      <button id="calcButton">Calculate TFR</button>
    </div>
    <h3>Results:</h3>
    <pre id="resultOutput"></pre>
  </div>

  <div id="tcrModule" class="module active">
    <div class="tcr-container">
      <h2>Tcr burnoff calc</h2>
      <p>Enter your cold resistance (in ohms) below. This calculator assumes that at 600¬∞F your device's resistance will be 0.79 Œ© as required for burnoffs.</p>
      <label for="coldRes">Cold Resistance (Œ©): </label>
      <input type="number" id="coldRes" step="any">
      <button id="tcrCalcButton">Calculate</button>
      <p class="warning"><strong>Warning:</strong> This tool performs standardized math for the temperature coefficient of resistance and then subtracts 3. While this should be accurate for all devices, it may not be accurate for yours. As such, Skrunk is not responsible for any damaged cups or mods that may occur due to the use of this calculator.</p>
      <h3>Result</h3>
      <p id="tcrResult"></p>
      <h3>Saved Calculations</h3>
      <div id="savedCalculations" class="saved-calculations"></div>
    </div>
  </div>
  
  <div id="submitModule" class="module">
    <div class="submission-form">
      <h2>Submit Your TFR Curve</h2>
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScSHdM6HtYnTjNJg4ZMBefj7amE1tOi5I1WmrxH22attDVZtw/viewform?embedded=true" scrolling="no" width="499" height="1299" frameborder="0" marginheight="0" marginwidth="0">Loading‚Ä¶</iframe>
    </div>
  </div>

  <div id="imageRepoModule" class="module">
    <h2>Skrunk Image Repository</h2>
    <div class="image-repo-controls">
      <div class="filter-container">
        <label for="dimensionFilter">Filter by dimensions:</label>
        <select id="dimensionFilter">
          <option value="all">All Images</option>
        </select>
      </div>
      <button id="refreshImagesBtn">Refresh Images</button>
    </div>
    <div id="imageContainer" class="image-grid">
      <p id="loadingImages">Loading images...</p>
    </div>
    <button id="scrollToTopBtn" class="scroll-to-top" title="Go to top"></button>
  </div>

<script>
const temperatureSets = {'7pt':[70,200,300,400,500,570,800],'8pt':[-40,70,200,300,400,500,570,800],'tsm':[-40,70,200,220,300,500,570,800],'auto':[70,200,300,400,500,600,800]};
let currentType = '7pt', currentTemperatures = temperatureSets[currentType], tempInputs = {}, resInputs = {}, calculatedCoefficients = [], isCelsius = false, cachedImages = [];

function fahrenheitToCelsius(f) {return Math.round((f-32)*5/9)}
function celsiusToFahrenheit(c) {return Math.round(c*9/5+32)}

function toggleTemperatureUnit() {
  const savedResValues = {};
  currentTemperatures.forEach(temp => {if(resInputs[temp]) savedResValues[temp] = resInputs[temp].value});
  isCelsius = !isCelsius;
  updateGrid(savedResValues);
}

function updateGrid(savedResValues = null) {
  tempInputs = {};
  resInputs = {};
  const grid = document.getElementById('gridContainer');
  grid.innerHTML = "";
  const headerRow = document.createElement('tr');
  const tempHeader = document.createElement('th');
  tempHeader.innerText = `Temperature (${isCelsius?'¬∞C':'¬∞F'})`;
  const resHeader = document.createElement('th');
  resHeader.innerText = "Resistance Value";
  headerRow.appendChild(tempHeader);
  headerRow.appendChild(resHeader);
  grid.appendChild(headerRow);

  currentTemperatures.forEach(temp => {
    const row = document.createElement('tr');
    const tempCell = document.createElement('td');
    const displayTemp = isCelsius ? fahrenheitToCelsius(temp) : temp;
    
    if (currentType === 'tsm') {
      if (temp === -40 || temp === 70 || temp === 200 || temp === 220) {
        tempCell.innerText = displayTemp;
        tempCell.dataset.fahrenheit = temp;
      } else {
        const inp = document.createElement('input');
        inp.type = 'number';
        inp.value = displayTemp;
        inp.step = '1'; 
        inp.dataset.fahrenheit = temp;
        tempCell.appendChild(inp);
        tempInputs[temp] = inp;
      }
    } else if (currentType === 'auto') {
      tempCell.innerText = displayTemp;
      tempCell.dataset.fahrenheit = temp;
    } else {
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.value = displayTemp;
      inp.step = '1'; 
      inp.dataset.fahrenheit = temp;
      tempCell.appendChild(inp);
      tempInputs[temp] = inp;
    }
    row.appendChild(tempCell);

    const resCell = document.createElement('td');
    const resInp = document.createElement('input');
    resInp.type = 'number';
    resInp.step = '0.001';
    if (currentType === 'tsm') {
      if (temp === -40 || temp === 200) {
        resInp.readOnly = true;
        resInp.style.backgroundColor = "#f0f0f0";
      }
      if (temp === 70) {
        resInp.addEventListener('input', updateTSMValues);
      }
    } else if (currentType === 'auto') {
      if (temp === 70) {
        resInp.addEventListener('input', autoFillValues);
      } else {
        resInp.readOnly = true;
        resInp.style.backgroundColor = "#f0f0f0";
      }
    }

    if (savedResValues && savedResValues[temp] !== undefined) {
      resInp.value = savedResValues[temp];
    }
    
    if (temp === 800 && document.getElementById("extrapolateCheck").checked) {
      resInp.readOnly = true;
      resInp.style.backgroundColor = "#f0f0f0";
    }
    
    resCell.appendChild(resInp);
    row.appendChild(resCell);
    resInputs[temp] = resInp;
    grid.appendChild(row);
  });
  
  setTimeout(setupExtrapolationListeners, 0);
}

function displaySavedCalculations() {
  var calculations = JSON.parse(localStorage.getItem('calculations')) || [];
  var savedCalculationsDiv = document.getElementById('savedCalculations');
  if (savedCalculationsDiv) {
    savedCalculationsDiv.innerHTML = calculations.map((calc, index) => 
      `Cold Resistance: ${calc.coldRes} Œ© - Required TCR: ${calc.tcrFull} <span class="delete-btn" onclick="deleteCalculation(${index})">&times;</span>`
    ).join('<br>');
  }
}

function showModule(moduleId) {
  document.querySelectorAll(".module").forEach(m => m.classList.remove("active"));
  document.getElementById(moduleId).classList.add("active");
}

function updateNavButtons(activeButtonId) {
  document.querySelectorAll(".nav-button").forEach(button => {
    if (button.id === activeButtonId) {
      button.classList.add("active");
    } else if (button.id !== "darkModeToggle") {
      button.classList.remove("active");
    }
  });
}

function applyDarkMode() {
  const darkMode = localStorage.getItem("darkMode") === "true";
  if (darkMode) {
    document.body.classList.add("dark-mode");
    const toggle = document.getElementById("darkModeToggle");
    if (toggle) toggle.textContent = "üåô";
  } else {
    document.body.classList.remove("dark-mode");
    const toggle = document.getElementById("darkModeToggle");
    if (toggle) toggle.textContent = "‚òÄÔ∏è";
  }
}

function autoFillValues() {
  if (currentType !== 'auto') return;
  const r70 = parseFloat(resInputs[70].value);
  if (isNaN(r70) || r70 <= 0) return;
  const r200 = r70 + 0.001, r600 = 0.79, r800 = r600 * 1.20;
  
  currentTemperatures.forEach(temp => {
    if (temp === 70) return;
    let value;
    if (temp === 200) value = r200;
    else if (temp === 600) value = r600;
    else if (temp === 800) value = r800;
    else {
      const progress = (temp - 200) / (600 - 200);
      const curveFactor = Math.pow(progress, 2);
      value = r200 + ((r600 - r200) * curveFactor);
    }
    resInputs[temp].value = value.toFixed(3);
  });
}

function updateTSMValues() {
  if (currentType !== 'tsm') return;
  const r70 = parseFloat(resInputs[70].value);
  if (isNaN(r70) || r70 <= 0) return;
  const rNeg40 = r70 * 0.920;
  resInputs[-40].value = rNeg40.toFixed(3);
  resInputs[200].value = (r70 + 0.001).toFixed(3);
}

function calculateTFR() {
  if (currentType === 'auto') autoFillValues();
  else if (currentType === 'tsm') updateTSMValues();
  
  let temps = [];
  currentTemperatures.forEach(temp => {
    if (tempInputs[temp]) {
      let parsed = parseFloat(tempInputs[temp].value);
      if (isCelsius && !isNaN(parsed)) parsed = celsiusToFahrenheit(parsed);
      temps.push(isNaN(parsed) ? temp : parsed);
    } else {
      temps.push(temp);
    }
  });
  
  let values = [];
  for (let i = 0; i < currentTemperatures.length; i++) {
    const val = parseFloat(resInputs[currentTemperatures[i]].value);
    if (isNaN(val)) {
      alert("Please enter all resistance values.");
      return;
    }
    values.push(val);
  }
  
  const R0 = values[currentType === 'tsm' ? 1 : 0];
  calculatedCoefficients = [];
  
  let resultStr = "Temperature (¬∞F), Electrical Resistivity\n";
  values.forEach((R, i) => {
    let coef = R / R0;
    if (document.getElementById("extrapolateContainer").style.display !== "none" &&
        document.getElementById("extrapolateCheck").checked &&
        currentTemperatures[i] === 800 && i > 1) {
      const secondLastTemp = currentTemperatures[i-2];
      const lastTemp = currentTemperatures[i-1];
      const secondLastRes = values[i-2];
      const lastRes = values[i-1];
      
      const m = (lastRes - secondLastRes) / (lastTemp - secondLastTemp);
      const b = lastRes - m * lastTemp;
      const extrapolatedRes = m * 800 + b;
      coef = extrapolatedRes / R0;
    }
    coef = parseFloat(coef.toFixed(3));
    
    let displayTemp = temps[i];
    calculatedCoefficients.push({ temp: displayTemp, coef: coef });
    resultStr += `${displayTemp}, ${coef.toFixed(3)}\n`;
  });
  document.getElementById("resultOutput").innerText = resultStr;
}

function importCSV(fileContent) {
  const lines = fileContent.trim().split(/\r?\n/);
  if (lines.length < 2) {
    alert("CSV file does not contain valid data.");
    return;
  }
  
  const tempsFromCSV = [], resistancesFromCSV = [];
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(/,|;/);
    if (parts.length >= 2) {
      const t = parseFloat(parts[0].replace(/"/g, "").trim());
      const r = parseFloat(parts[1].replace(/"/g, "").trim());
      if (!isNaN(t) && !isNaN(r)) {
        tempsFromCSV.push(t);
        resistancesFromCSV.push(r);
      }
    }
  }
  
  if (tempsFromCSV.length === 0) {
    alert("No valid data found in CSV file.");
    return;
  }
  
  let newType = '7pt';
  if (tempsFromCSV.length === 8) {
    newType = '8pt';
  } else if (tempsFromCSV.length === 7 && tempsFromCSV.some(t => Math.abs(t - 220) < 1)) {
    newType = 'tsm';
  }
  
  currentType = newType;
  currentTemperatures = temperatureSets[currentType];
  document.querySelectorAll("input[name='curveType']").forEach(radio => {
    radio.checked = (radio.value === currentType);
  });
  
  updateGrid();
  
  let baseResistance = parseFloat(window.prompt("Enter base resistance value:", "1.0"));
  if (isNaN(baseResistance)) {
    alert("Invalid base resistance. Aborting import.");
    return;
  }
  
  tempsFromCSV.forEach((t, idx) => {
    let closest = currentTemperatures[0];
    let diff = Math.abs(t - closest);
    currentTemperatures.forEach(ct => {
      const d = Math.abs(t - ct);
      if (d < diff) {
        diff = d;
        closest = ct;
      }
    });
    if (resInputs[closest]) {
      resInputs[closest].value = (resistancesFromCSV[idx] * baseResistance).toFixed(3);
    }
  });
  
  if (currentType === 'tsm') updateTSMValues();
  else if (currentType === 'auto') autoFillValues();
  
  alert(`CSV data imported successfully with base resistance of ${baseResistance}.`);
}

function exportCSV() {
  if (!calculatedCoefficients.length) {
    alert("Please calculate TFR values first!");
    return;
  }
  
  let csvContent = "Temperature (¬∞F),Electrical Resistivity\n";
  calculatedCoefficients.forEach(pair => {
    csvContent += `${pair.temp},${pair.coef.toFixed(3)}\n`;
  });
  
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "tfrcalc.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function calculateTCR() {
  var coldRes = parseFloat(document.getElementById('coldRes').value);
  if (isNaN(coldRes) || coldRes <= 0) {
    document.getElementById('tcrResult').innerText = "Please enter a valid positive number for cold resistance.";
    return;
  }
  
  var tcrFraction = (0.79 / coldRes - 1) / 600;
  var tcrFull = Math.round(tcrFraction * 200000) - 3;
  document.getElementById('tcrResult').innerText = "Required TCR (full number): " + tcrFull;
  
  saveCalculation(coldRes, tcrFull);
  displaySavedCalculations();
}

function saveCalculation(coldRes, tcrFull) {
  var calculations = JSON.parse(localStorage.getItem('calculations')) || [];
  calculations.push({ coldRes: coldRes, tcrFull: tcrFull });
  localStorage.setItem('calculations', JSON.stringify(calculations));
}

function deleteCalculation(index) {
  var calculations = JSON.parse(localStorage.getItem('calculations')) || [];
  calculations.splice(index, 1);
  localStorage.setItem('calculations', JSON.stringify(calculations));
  displaySavedCalculations();
}

function extrapolate800Value() {
  if (!document.getElementById("extrapolateCheck").checked) return;
  
  const index800 = currentTemperatures.indexOf(800);
  if (index800 === -1 || index800 < 2) return;
  
  const secondLastTemp = currentTemperatures[index800-2];
  const lastTemp = currentTemperatures[index800-1];
  const secondLastResInput = resInputs[secondLastTemp];
  const lastResInput = resInputs[lastTemp];
  const res800Input = resInputs[800];
  
  if (!secondLastResInput || !lastResInput || !res800Input) return;
  
  const secondLastRes = parseFloat(secondLastResInput.value);
  const lastRes = parseFloat(lastResInput.value);
  
  if (isNaN(secondLastRes) || isNaN(lastRes)) return;
  
  const m = (lastRes - secondLastRes) / (lastTemp - secondLastTemp);
  const b = lastRes - m * lastTemp;
  const extrapolatedRes = m * 800 + b;
  
  res800Input.value = extrapolatedRes.toFixed(3);
  res800Input.readOnly = true;
  res800Input.style.backgroundColor = "#f0f0f0";
}

function setupExtrapolationListeners() {
  const index800 = currentTemperatures.indexOf(800);
  if (index800 < 2) return;
  
  const secondLastTemp = currentTemperatures[index800-2];
  const lastTemp = currentTemperatures[index800-1];
  
  if (resInputs[secondLastTemp]) resInputs[secondLastTemp].addEventListener('input', extrapolate800Value);
  if (resInputs[lastTemp]) resInputs[lastTemp].addEventListener('input', extrapolate800Value);
}

function setupScrollToTopButton() {
  const scrollToTopBtn = document.getElementById("scrollToTopBtn");
  
  window.addEventListener("scroll", function() {
    if (document.getElementById("imageRepoModule").classList.contains("active")) {
      scrollToTopBtn.classList[window.pageYOffset > 200 ? 'add' : 'remove']("visible");
    }
  });
  
  scrollToTopBtn.addEventListener("click", () => window.scrollTo({top: 0, behavior: "smooth"}));
}

async function fetchImagesFromGitHub() {
  const loadingMsg = document.getElementById('loadingImages');
  loadingMsg.textContent = 'Loading images...';
  
  try {
    const response = await fetch('https://api.github.com/repos/alopez5301/AFREPO/contents/images');
    if (!response.ok) throw new Error(`GitHub API error: ${response.status}`);
    
    const data = await response.json();
    const imageFiles = data.filter(file => /\.(jpg|jpeg|png|bmp)$/i.test(file.name));
    
    // Process images in batches to prevent overwhelming browser
    const batchSize = 5;
    const batches = [];
    
    for (let i = 0; i < imageFiles.length; i += batchSize) {
      batches.push(imageFiles.slice(i, i + batchSize));
    }
    
    cachedImages = [];
    
    for (const batch of batches) {
      const batchResults = await Promise.all(batch.map(file => getImageDetails(file)));
      cachedImages.push(...batchResults);
      
      // Update UI after each batch to show progress
      if (cachedImages.length) {
        loadingMsg.textContent = `Loading images... (${cachedImages.length}/${imageFiles.length})`;
        updateDimensionFilter(cachedImages);
        displayImages(cachedImages);
      }
    }
  } catch (error) {
    loadingMsg.textContent = `Error loading images: ${error.message}`;
    console.error('Error fetching images:', error);
  }
}

async function getImageDetails(file) {
  const imageUrl = file.download_url;
  const img = new Image();
  
  const dimensions = await new Promise(resolve => {
    img.onload = () => resolve({width: img.width, height: img.height});
    img.onerror = () => resolve({width: 0, height: 0});
    img.src = imageUrl;
  });
  
  return {
    name: file.name,
    url: imageUrl,
    width: dimensions.width,
    height: dimensions.height
  };
}

function updateDimensionFilter(images) {
  const dimensions = new Set();
  images.forEach(img => dimensions.add(`${img.width}x${img.height}`));
  
  const dimensionFilter = document.getElementById('dimensionFilter');
  const currentSelection = dimensionFilter.value;
  
  while (dimensionFilter.options.length > 1) dimensionFilter.remove(1);
    Array.from(dimensions)
    .sort((a, b) => {
      const [widthA, heightA] = a.split('x').map(Number);
      const [widthB, heightB] = b.split('x').map(Number);
      return widthB - widthA || heightB - heightA; // Sort by width (largest first), then height
    })
    .forEach(dimension => {
      const option = document.createElement('option');
      option.value = option.textContent = dimension;
      dimensionFilter.appendChild(option);
    });

  dimensionFilter.value = Array.from(dimensionFilter.options).some(option => option.value === currentSelection) ? 
    currentSelection : 'all';
}

function displayImages(images) {
  const container = document.getElementById('imageContainer');
  const dimensionFilter = document.getElementById('dimensionFilter').value;
  const loadingMessage = document.getElementById('loadingImages');
  
  container.innerHTML = '';
  container.appendChild(loadingMessage);
  
  // Filter images more efficiently with early return
  let filteredImages = images;
  if (dimensionFilter !== 'all') {
    const [filterWidth, filterHeight] = dimensionFilter.split('x').map(Number);
    filteredImages = images.filter(img => img.width === filterWidth && img.height === filterHeight);
  }
  
  if (filteredImages.length === 0) {
    loadingMessage.textContent = 'No images match the selected filter';
    return;
  }
    // Sort by width primarily (largest to smallest)
  filteredImages.sort((a, b) => b.width - a.width || b.height - a.height);
  loadingMessage.style.display = 'none';
  
  // Create document fragment for batch DOM operations
  const fragment = document.createDocumentFragment();
  
  // Create template for card HTML to minimize DOM operations
  const cardTemplate = document.createElement('template');
  cardTemplate.innerHTML = 
    '<div class="image-card" style="height:auto">' +
      '<img style="width:100%;height:auto;cursor:pointer" loading="lazy">' +
      '<div class="image-info"></div>' + 
      '<button class="download-btn">Download</button>' +
    '</div>';
  
  filteredImages.forEach(img => {
    // Clone the template instead of creating elements individually
    const card = cardTemplate.content.cloneNode(true).firstElementChild;
    const image = card.querySelector('img');
    image.src = img.url;
    image.alt = img.name;
    image.addEventListener('click', () => window.open(img.url, '_blank'));
    
    card.querySelector('.image-info').textContent = `${img.name} (${img.width}x${img.height})`;
    
    const downloadBtn = card.querySelector('.download-btn');
    downloadBtn.addEventListener('click', e => {
      e.stopPropagation();
      const link = document.createElement('a');
      link.href = img.url;
      link.download = img.name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    
    fragment.appendChild(card);
  });
  
  // Append all cards at once to minimize reflows
  container.appendChild(fragment);
}

// Initialize event listeners
document.querySelectorAll("input[name='curveType']").forEach(radio => {
  radio.addEventListener("change", function() {
    if (this.checked) {
      currentType = this.value;
      currentTemperatures = temperatureSets[currentType];
      updateGrid();
      document.getElementById("extrapolateContainer").style.display = currentType === 'auto' ? "none" : "block";
      setTimeout(setupExtrapolationListeners, 100);
    }
  });
});

document.getElementById("extrapolateCheck").addEventListener('change', function() {
  const res800Input = resInputs[800];
  if (this.checked) {
    extrapolate800Value();
    if (res800Input) {
      res800Input.readOnly = true;
      res800Input.style.backgroundColor = "#f0f0f0";
    }
  } else if (res800Input) {
    res800Input.readOnly = false;
    res800Input.style.backgroundColor = "";
  }
});

document.getElementById("calcButton").addEventListener("click", calculateTFR);
document.getElementById("exportButton").addEventListener("click", exportCSV);
document.getElementById("importButton").addEventListener("click", () => document.getElementById("csvFileInput").click());
document.getElementById("csvFileInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => importCSV(e.target.result);
    reader.readAsText(file);
    this.value = "";
  }
});
document.getElementById("tcrCalcButton").addEventListener("click", calculateTCR);
document.getElementById("tempUnitToggle").addEventListener("click", toggleTemperatureUnit);
document.getElementById("tfrNavBtn").addEventListener("click", function() {
  showModule("tfrModule");
  updateNavButtons("tfrNavBtn");
});
document.getElementById("tcrNavBtn").addEventListener("click", function() {
  showModule("tcrModule");
  updateNavButtons("tcrNavBtn");
});
document.getElementById("submitNavBtn").addEventListener("click", function() {
  showModule("submitModule");
  updateNavButtons("submitNavBtn");
});
document.getElementById("imageRepoNavBtn").addEventListener("click", function() {
  showModule("imageRepoModule");
  updateNavButtons("imageRepoNavBtn");
  if (cachedImages.length === 0) fetchImagesFromGitHub();
  setupScrollToTopButton();
});
document.getElementById("darkModeToggle").addEventListener("click", function() {
  document.body.classList.toggle("dark-mode");
  const isDarkMode = document.body.classList.contains("dark-mode");
  localStorage.setItem("darkMode", isDarkMode ? "true" : "false");
  this.textContent = isDarkMode ? "üåô" : "‚òÄÔ∏è";
});

// Initialize app on page load
document.addEventListener("DOMContentLoaded", function () {
  applyDarkMode();
  updateGrid();
  displaySavedCalculations();
  setupExtrapolationListeners();

  const dimensionFilter = document.getElementById('dimensionFilter');
  if (dimensionFilter) {
    dimensionFilter.addEventListener('change', () => {
      if (cachedImages.length > 0) displayImages(cachedImages);
    });
  }
  
  const refreshImagesBtn = document.getElementById('refreshImagesBtn');
  if (refreshImagesBtn) {
    refreshImagesBtn.addEventListener('click', fetchImagesFromGitHub);
  }

  const dateInput = document.getElementById('submitDate');
  if (dateInput) {
    dateInput.value = new Date().toISOString().split('T')[0];
  }
  
  if (document.getElementById("imageRepoModule").classList.contains("active")) {
    setupScrollToTopButton();
  }
});
</script>
</body>
</html>
